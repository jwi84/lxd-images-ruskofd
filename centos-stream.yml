---
image:
  distribution: centos
  release: 8-Stream
  architecture: x86_64
  name: "{{ image.distribution }}-{{ image.release }}-{{ image.variant }}-{{ image.serial }}"
  description: "CentOS {{ image.release }} ({{ image.variant }}-{{ image.serial }})"
  variant: default

source:
  downloader: centos-http
  url: https://fr2.rpmfind.net/linux/centos
  variant: boot

targets:
  lxd:
    vm:
      filesystem: ext4
      size: 34359738368 # 32 GiB

packages:
  manager: dnf
  update: true
  cleanup: true
  sets:
  - packages:
    - bash-completion
    - cloud-init
    - dnf-plugins-core
    - epel-release
    - epel-next-release
    - glibc-langpack-en
    - glibc-locale-source
    - hostname
    - iproute
    - iputils
    - less
    - lsof
    - NetworkManager
    - nmap-ncat
    - nftables
    - passwd
    - rootfiles
    - strace
    - tar
    - unzip
    - vim-minimal
    - wget
    action: install

  - packages:
    - chrony
    - cloud-utils-growpart
    - grub2-efi-x64
    - kernel
    - shim
    action: install
    types:
    - vm

  - packages:
    - linux-firmware
    - polkit
    action: remove
    types:
    - vm

actions:
  # Generate machine-id in order for the kernel stuff to be configured properly
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      systemd-machine-id-setup
    types:
    - vm

  # Configure timezone
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      ln -sfn /usr/share/zoneinfo/Etc/UTC /etc/localtime
      echo "Etc/UTC" > /etc/timezone

  # Configure locale 
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      # Set default locale
      localedef -i en_US -f UTF-8 en_US.UTF-8
      echo 'LANG=en_US.utf8' > /etc/locale.conf
  # Enable extra repos (EPEL)
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      dnf config-manager --set-enabled powertools
    releases:
    - 8-Stream

  # Enable extra repos (EPEL)
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      dnf config-manager --set-enabled crb
    releases:
    - 9-Stream

  # Fix symlink for Python on CentOS Stream 8
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      ln -sf /usr/libexec/platform-python3.6 /usr/libexec/platform-python
    releases:
    - 8-Stream

  # Default systemd units to enable
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      systemctl enable NetworkManager \
                       nftables \
                       cloud-init \
                       cloud-init-local \
                       cloud-config \
                       cloud-final

  # Additionnal units to manage for VMs
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      systemctl enable chronyd
    types:
    - vm

  - trigger: post-files
    action: |-
      #!/bin/sh
      set -eux
  
      # Regenerate initramfs
      kver=$(ls /boot/initramfs-*.img | sed -r 's#.*initramfs-(.+)\.img#\1#')
      dracut --kver "${kver}" -f
  
      target="$(readlink -f /etc/grub2-efi.cfg)"
      grub2-mkconfig -o "${target}"
  
      sed -i "s#root=[^ ]*#root=/dev/sda2#g" "${target}"
    types:
    - vm
    releases:
    - 8-Stream
  
  - trigger: post-files
    action: |-
      #!/bin/sh
      set -eux
      kver=$(ls /boot/initramfs-*.img | sed -r 's#.*initramfs-(.+)\.img#\1#')
      target=/boot/efi/EFI/centos/grub.cfg
  
      # Create grub.cfg file
      grub2-mkconfig -o "${target}"
      sed -i "s#root=[^ ]*#root=/dev/sda2#g" "${target}"
  
      # Update files in /boot/loader/entries/. `grubby` needs to be run after
      # `grub2-mkconfig` as the latter overwrites files in /boot/loader/entries/.
      grubby --update-kernel=/boot/vmlinuz-${kver} --args="root=/dev/sda2 ro"
  
      # Regenerate initramfs
      dracut --kver "${kver}" -f
    types:
    - vm
    releases:
    - 9-Stream

files:
  - name: fstab
    generator: fstab
    types:
    - vm

  - path: /etc/fstab
    generator: dump
    types:
    - container

  - path: /etc/machine-id
    generator: dump

  - path: /var/lib/dbus/machine-id
    generator: remove

  - path: /etc/hostname
    generator: hostname

  - path: /etc/hosts
    generator: hosts

  - name: lxd-agent
    generator: lxd-agent
    types:
    - vm

  - name: meta-data
    generator: cloud-init

  - name: user-data
    generator: cloud-init

  - name: vendor-data
    generator: cloud-init

  - name: network-config
    generator: cloud-init
    content: |-
      {% if config_get("user.network-config", "") == "" %}version: 1
      config:
        - type: physical
          name: {% if instance.type == "virtual-machine" %}enp5s0{% else %}eth0{% endif %}
          subnets:
            - type: {% if config_get("user.network_mode", "") == "link-local" %}manual{% else %}dhcp{% endif %}
              control: auto
            - type: dhcp6
              control: auto{% else %}{{ config_get("user.network-config", "") }}{% endif %}
    releases:
    - 8-Stream
    - 9-Stream

  - path: /etc/default/grub
    generator: dump
    content: |-
      # Set the recordfail timeout
      GRUB_RECORDFAIL_TIMEOUT=0
      # Do not wait on grub prompt
      GRUB_TIMEOUT=0
      # Set the default commandline
      GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT} console=tty1 console=ttyS0"
      # Set the grub console type
      GRUB_TERMINAL=console
      # Disable os-prober
      GRUB_DISABLE_OS_PROBER=true
    types:
    - vm

  - path: /etc/dracut.conf.d/lxd.conf
    generator: dump
    content: |-
      add_drivers+=" virtio_scsi virtio_console sd_mod "
    types:
    - vm

  # Blacklist IPMI module since it's loaded in VM and therefore the module-load systemd service crash
  # Link: https://bugzilla.redhat.com/show_bug.cgi?id=2037294  
  - path: /etc/modprobe.d/blacklist-ipmi.conf
    generator: dump
    content: |-
      blacklist ipmi_si
    types:
    - vm
    releases:
    - 8-Stream

  - path: /etc/sysctl.d/10-silence-audit.conf
    source: config/sysctl/10-silence-audit.conf
    generator: copy
    types:
    - vm

  - path: /etc/udev/rules.d/80-iosched.rules
    source: config/udev/80-iosched.rules
    generator: copy
    types:
    - vm

  - path: /etc/udev/rules.d/80-cpu-hotplug.rules
    source: config/udev/80-cpu-hotplug.rules
    generator: copy
    types:
    - vm

  - path: /etc/udev/rules.d/86-nm-unmanaged.rules
    generator: dump
    content: |-
      ENV{ID_NET_DRIVER}=="veth", ENV{NM_UNMANAGED}="0"
    releases:
    - 8-Stream
    - 9-Stream

  - path: /etc/systemd/journald.conf
    source: config/systemd-journald/journald.conf
    generator: copy

  - path: /etc/chrony.conf
    source: config/chrony/chrony.conf
    generator: copy

  - path: /etc/dnf/dnf.conf
    source: config/dnf/dnf.conf
    generator: copy

  - path: /etc/cloud/cloud.cfg
    source: config/cloud-init/rhel.cfg
    generator: copy
